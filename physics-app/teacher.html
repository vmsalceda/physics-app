<!DOCTYPE html>
<html>
<head>
  <title>Teacher Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { Plus, Trash2, Edit2, LogOut, CheckCircle, XCircle } = lucide;

    function TeacherDashboard() {
      const [problems, setProblems] = useState([]);
      const [assignments, setAssignments] = useState([]);
      const [submissions, setSubmissions] = useState([]);
      const [activeTab, setActiveTab] = useState('problems');
      const [showProblemForm, setShowProblemForm] = useState(false);
      const [editingProblem, setEditingProblem] = useState(null);
      const [problemForm, setProblemForm] = useState({
        title: '', description: '', variables: [], formula: '', unit: '', tolerancePercent: 2, maxAttempts: 3
      });
      const [showAssignmentForm, setShowAssignmentForm] = useState(false);
      const [editingAssignment, setEditingAssignment] = useState(null);
      const [assignmentForm, setAssignmentForm] = useState({
        title: '', description: '', problemIds: [], dueDate: ''
      });
      const [viewingGrades, setViewingGrades] = useState(null);

      useEffect(() => {
        loadProblems();
        loadAssignments();
        loadSubmissions();
      }, []);

      async function loadProblems() {
        const res = await fetch('/api/problems');
        const data = await res.json();
        setProblems(data);
      }

      async function loadAssignments() {
        const res = await fetch('/api/assignments');
        const data = await res.json();
        setAssignments(data);
      }

      async function loadSubmissions() {
        const res = await fetch('/api/submissions/all');
        const data = await res.json();
        setSubmissions(data);
      }

      async function saveProblem() {
        if (!problemForm.title || !problemForm.formula || problemForm.variables.length === 0) {
          alert('Please fill all fields');
          return;
        }
        
        const vars = {};
        problemForm.variables.forEach(v => {
          if (v.name) vars[v.name] = { min: parseFloat(v.min), max: parseFloat(v.max) };
        });

        const data = {
          title: problemForm.title,
          description: problemForm.description,
          variables: vars,
          formula: problemForm.formula,
          unit: problemForm.unit,
          tolerancePercent: parseFloat(problemForm.tolerancePercent),
          maxAttempts: parseInt(problemForm.maxAttempts)
        };

        if (editingProblem) {
          await fetch(`/api/problems/${editingProblem.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          await fetch('/api/problems', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        setProblemForm({ title: '', description: '', variables: [], formula: '', unit: '', tolerancePercent: 2, maxAttempts: 3 });
        setShowProblemForm(false);
        setEditingProblem(null);
        loadProblems();
      }

      async function deleteProblem(id) {
        if (confirm('Delete this problem?')) {
          await fetch(`/api/problems/${id}`, { method: 'DELETE' });
          loadProblems();
        }
      }

      async function saveAssignment() {
        if (!assignmentForm.title || assignmentForm.problemIds.length === 0) {
          alert('Please fill all fields');
          return;
        }

        const data = {
          title: assignmentForm.title,
          description: assignmentForm.description,
          problemIds: assignmentForm.problemIds,
          dueDate: assignmentForm.dueDate
        };

        if (editingAssignment) {
          await fetch(`/api/assignments/${editingAssignment.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          await fetch('/api/assignments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        setAssignmentForm({ title: '', description: '', problemIds: [], dueDate: '' });
        setShowAssignmentForm(false);
        setEditingAssignment(null);
        loadAssignments();
      }

      async function deleteAssignment(id) {
        if (confirm('Delete this assignment?')) {
          await fetch(`/api/assignments/${id}`, { method: 'DELETE' });
          loadAssignments();
        }
      }

      return (
        <div className="min-h-screen bg-gray-50 p-6">
          <div className="max-w-6xl mx-auto">
            <div className="bg-white rounded-lg shadow p-6 mb-6">
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-3xl font-bold">Teacher Dashboard</h1>
                <a href="/logout" className="flex items-center gap-2 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                  <LogOut size={18} /> Logout
                </a>
              </div>

              <div className="flex gap-4 border-b mb-6">
                <button onClick={() => setActiveTab('problems')} className={`pb-2 px-4 font-medium ${activeTab === 'problems' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600'}`}>Problems</button>
                <button onClick={() => setActiveTab('assignments')} className={`pb-2 px-4 font-medium ${activeTab === 'assignments' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600'}`}>Assignments</button>
                <button onClick={() => setActiveTab('grades')} className={`pb-2 px-4 font-medium ${activeTab === 'grades' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600'}`}>Grade Book</button>
              </div>

              {activeTab === 'problems' && (
                <div>
                  <button onClick={() => { setShowProblemForm(true); setEditingProblem(null); setProblemForm({ title: '', description: '', variables: [], formula: '', unit: '', tolerancePercent: 2, maxAttempts: 3 }); }}
                    className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg mb-4 hover:bg-indigo-700">
                    <Plus size={18} /> Add Problem
                  </button>

                  {showProblemForm && (
                    <div className="bg-gray-50 rounded-lg p-6 mb-6 border">
                      <h2 className="text-xl font-bold mb-4">{editingProblem ? 'Edit' : 'Create'} Problem</h2>
                      <input type="text" placeholder="Title" value={problemForm.title} onChange={(e) => setProblemForm({ ...problemForm, title: e.target.value })} className="w-full px-3 py-2 border rounded-lg mb-3" />
                      <textarea placeholder="Description (use {variable})" value={problemForm.description} onChange={(e) => setProblemForm({ ...problemForm, description: e.target.value })} className="w-full px-3 py-2 border rounded-lg mb-3" rows="2" />
                      
                      <div className="mb-3">
                        <label className="font-medium mb-2 block">Variables</label>
                        {problemForm.variables.map((v, i) => (
                          <div key={i} className="flex gap-2 mb-2">
                            <input type="text" placeholder="Name" value={v.name} onChange={(e) => { const nv = [...problemForm.variables]; nv[i].name = e.target.value; setProblemForm({ ...problemForm, variables: nv }); }} className="flex-1 px-3 py-2 border rounded-lg" />
                            <input type="number" placeholder="Min" value={v.min} onChange={(e) => { const nv = [...problemForm.variables]; nv[i].min = e.target.value; setProblemForm({ ...problemForm, variables: nv }); }} className="w-20 px-3 py-2 border rounded-lg" />
                            <input type="number" placeholder="Max" value={v.max} onChange={(e) => { const nv = [...problemForm.variables]; nv[i].max = e.target.value; setProblemForm({ ...problemForm, variables: nv }); }} className="w-20 px-3 py-2 border rounded-lg" />
                            <button onClick={() => setProblemForm({ ...problemForm, variables: problemForm.variables.filter((_, j) => j !== i) })} className="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">
                              <Trash2 size={18} />
                            </button>
                          </div>
                        ))}
                        <button onClick={() => setProblemForm({ ...problemForm, variables: [...problemForm.variables, { name: '', min: '', max: '' }] })} className="text-indigo-600 text-sm hover:underline">+ Add Variable</button>
                      </div>

                      <div className="flex gap-3 mb-3">
                        <input type="text" placeholder="Formula (e.g., distance / time)" value={problemForm.formula} onChange={(e) => setProblemForm({ ...problemForm, formula: e.target.value })} className="flex-1 px-3 py-2 border rounded-lg" />
                        <input type="text" placeholder="Unit" value={problemForm.unit} onChange={(e) => setProblemForm({ ...problemForm, unit: e.target.value })} className="w-24 px-3 py-2 border rounded-lg" />
                        <input type="number" step="0.1" placeholder="Tol%" value={problemForm.tolerancePercent} onChange={(e) => setProblemForm({ ...problemForm, tolerancePercent: e.target.value })} className="w-24 px-3 py-2 border rounded-lg" />
                        <input type="number" placeholder="Max Attempts" value={problemForm.maxAttempts} onChange={(e) => setProblemForm({ ...problemForm, maxAttempts: e.target.value })} className="w-32 px-3 py-2 border rounded-lg" />
                      </div>

                      <div className="flex gap-2">
                        <button onClick={saveProblem} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                        <button onClick={() => { setShowProblemForm(false); setEditingProblem(null); }} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                      </div>
                    </div>
                  )}

                  {problems.map(p => (
                    <div key={p.id} className="bg-white border rounded-lg p-4 mb-3">
                      <div className="flex justify-between">
                        <div>
                          <h3 className="font-bold">{p.title}</h3>
                          <p className="text-sm text-gray-600">{p.description}</p>
                          <p className="text-xs text-gray-500 mt-1">{p.formula} {p.unit} (Â±{p.tolerance_percent}%) | Max: {p.max_attempts}</p>
                        </div>
                        <div className="flex gap-2">
                          <button onClick={() => { 
                            setEditingProblem(p); 
                            setProblemForm({ 
                              title: p.title, 
                              description: p.description, 
                              variables: Object.keys(p.variables).map(n => ({ name: n, min: p.variables[n].min, max: p.variables[n].max })), 
                              formula: p.formula, 
                              unit: p.unit, 
                              tolerancePercent: p.tolerance_percent, 
                              maxAttempts: p.max_attempts 
                            }); 
                            setShowProblemForm(true); 
                          }} className="p-2 text-indigo-600 hover:bg-indigo-50 rounded">
                            <Edit2 size={16} />
                          </button>
                          <button onClick={() => deleteProblem(p.id)} className="p-2 text-red-600 hover:bg-red-50 rounded">
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {activeTab === 'assignments' && (
                <div>
                  <button onClick={() => { setShowAssignmentForm(true); setEditingAssignment(null); setAssignmentForm({ title: '', description: '', problemIds: [], dueDate: '' }); }}
                    className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg mb-4 hover:bg-indigo-700">
                    <Plus size={18} /> Create Assignment
                  </button>

                  {showAssignmentForm && (
                    <div className="bg-gray-50 rounded-lg p-6 mb-6 border">
                      <h2 className="text-xl font-bold mb-4">{editingAssignment ? 'Edit' : 'Create'} Assignment</h2>
                      <input type="text" placeholder="Title" value={assignmentForm.title} onChange={(e) => setAssignmentForm({ ...assignmentForm, title: e.target.value })} className="w-full px-3 py-2 border rounded-lg mb-3" />
                      <textarea placeholder="Description" value={assignmentForm.description} onChange={(e) => setAssignmentForm({ ...assignmentForm, description: e.target.value })} className="w-full px-3 py-2 border rounded-lg mb-3" rows="2" />
                      <input type="date" value={assignmentForm.dueDate} onChange={(e) => setAssignmentForm({ ...assignmentForm, dueDate: e.target.value })} className="w-full px-3 py-2 border rounded-lg mb-3" />
                      
                      <div className="mb-3">
                        <label className="font-medium mb-2 block">Select Problems</label>
                        {problems.map(p => (
                          <div key={p.id} className="flex items-center gap-2 p-2 border rounded mb-2">
                            <input type="checkbox" checked={assignmentForm.problemIds.includes(p.id)} onChange={() => { 
                              const ids = assignmentForm.problemIds; 
                              setAssignmentForm({ ...assignmentForm, problemIds: ids.includes(p.id) ? ids.filter(x => x !== p.id) : [...ids, p.id] }); 
                            }} />
                            <div>
                              <div className="font-medium text-sm">{p.title}</div>
                              <div className="text-xs text-gray-600">{p.description}</div>
                            </div>
                          </div>
                        ))}
                      </div>

                      <div className="flex gap-2">
                        <button onClick={saveAssignment} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                        <button onClick={() => { setShowAssignmentForm(false); setEditingAssignment(null); }} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                      </div>
                    </div>
                  )}

                  {assignments.map(a => (
                    <div key={a.id} className="bg-white border rounded-lg p-4 mb-3">
                      <div className="flex justify-between">
                        <div>
                          <h3 className="font-bold">{a.title}</h3>
                          <p className="text-sm text-gray-600">{a.description}</p>
                          <p className="text-xs text-gray-500 mt-1">Due: {new Date(a.due_date).toLocaleDateString()} | {a.problem_ids.length} problems</p>
                        </div>
                        <div className="flex gap-2">
                          <button onClick={() => { 
                            setEditingAssignment(a); 
                            setAssignmentForm({ 
                              title: a.title, 
                              description: a.description, 
                              problemIds: a.problem_ids, 
                              dueDate: a.due_date 
                            }); 
                            setShowAssignmentForm(true); 
                          }} className="p-2 text-indigo-600 hover:bg-indigo-50 rounded">
                            <Edit2 size={16} />
                          </button>
                          <button onClick={() => deleteAssignment(a.id)} className="p-2 text-red-600 hover:bg-red-50 rounded">
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {activeTab === 'grades' && (
                <div>
                  <h2 className="text-xl font-bold mb-4">Grade Book</h2>
                  <p className="text-gray-600">View student submissions and grades here.</p>
                  {/* Add grade book view here */}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<TeacherDashboard />, document.getElementById('root'));
  </script>
</body>
</html>