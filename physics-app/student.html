<!DOCTYPE html>
<html>
<head>
  <title>Student Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Simple icon components
    const LogOut = () => <span>üö™</span>;
    const CheckCircle = () => <span>‚úÖ</span>;
    const XCircle = () => <span>‚ùå</span>;

    function StudentDashboard() {
      const [assignments, setAssignments] = useState([]);
      const [problems, setProblems] = useState([]);
      const [submissions, setSubmissions] = useState([]);
      const [selectedAssignment, setSelectedAssignment] = useState(null);
      const [inputValues, setInputValues] = useState({});

      useEffect(() => {
        loadData();
      }, []);

      async function loadData() {
        try {
          const [assignRes, probRes, subRes] = await Promise.all([
            fetch('/api/assignments'),
            fetch('/api/problems'),
            fetch('/api/submissions')
          ]);
          setAssignments(await assignRes.json());
          setProblems(await probRes.json());
          setSubmissions(await subRes.json());
        } catch (err) {
          console.error('Error loading data:', err);
        }
      }

      function generateValues(variables) {
        const values = {};
        for (const [varName, range] of Object.entries(variables)) {
          values[varName] = Math.random() * (range.max - range.min) + range.min;
        }
        return values;
      }

      function renderProblemText(description, values) {
        let text = description;
        for (const [varName, value] of Object.entries(values)) {
          text = text.replace(`{${varName}}`, value.toFixed(2));
        }
        return text;
      }

      async function submitAnswer(assignmentId, problemId, answer) {
        if (!answer) {
          alert('Please enter an answer');
          return;
        }

        try {
          const res = await fetch('/api/submit-answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ assignmentId, problemId, answer })
          });

          const result = await res.json();
          if (result.error) {
            alert(result.error);
          } else {
            await loadData();
            setInputValues({ ...inputValues, [`${assignmentId}_${problemId}`]: '' });
          }
        } catch (err) {
          alert('Error submitting answer: ' + err.message);
        }
      }

      if (selectedAssignment) {
        const assignment = selectedAssignment;
        const assignmentSubs = submissions.filter(s => s.assignment_id === assignment.id);
        const total = assignment.problem_ids.length;
        const correct = assignmentSubs.filter(s => s.is_correct).length;
        const grade = total > 0 ? (correct / total * 100) : 0;

        return (
          <div className="min-h-screen bg-gray-50 p-6">
            <div className="max-w-4xl mx-auto">
              <div className="bg-white rounded-lg shadow p-6 mb-6">
                <div className="flex justify-between items-start mb-4">
                  <div className="flex-1">
                    <h1 className="text-2xl font-bold text-gray-800">{assignment.title}</h1>
                    <p className="text-gray-600 text-sm mt-1">{assignment.description}</p>
                    <p className="text-gray-500 text-xs mt-2">Due: {new Date(assignment.due_date).toLocaleDateString()}</p>
                  </div>
                  <button 
                    onClick={() => setSelectedAssignment(null)} 
                    className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition ml-4">
                    ‚Üê Back
                  </button>
                </div>
                <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 flex justify-between items-center border border-indigo-100">
                  <div>
                    <span className="text-sm text-gray-600">Progress:</span>
                    <span className="ml-2 font-bold text-lg text-gray-800">{correct}/{total}</span>
                  </div>
                  <div>
                    <span className="text-sm text-gray-600">Grade:</span>
                    <span className={`ml-2 px-3 py-1 rounded-full text-sm font-bold ${
                      grade === 100 ? 'bg-green-100 text-green-800' : 
                      grade >= 70 ? 'bg-yellow-100 text-yellow-800' : 
                      correct > 0 ? 'bg-red-100 text-red-800' : 
                      'bg-gray-100 text-gray-600'
                    }`}>
                      {correct > 0 || grade === 100 ? `${Math.round(grade)}%` : 'Not started'}
                    </span>
                  </div>
                </div>
              </div>

              {assignment.problem_ids.map((pid, i) => {
                const prob = problems.find(p => p.id === pid);
                if (!prob) return null;

                let sub = assignmentSubs.find(s => s.problem_id === pid);
                let vals = sub ? sub.problem_instances : generateValues(prob.variables);
                const txt = renderProblemText(prob.description, vals);
                const inputKey = `${assignment.id}_${pid}`;
                const inp = inputValues[inputKey] || '';
                const isDisabled = sub?.is_correct || (sub?.attempts || 0) >= prob.max_attempts;

                return (
                  <div key={pid} className="bg-white rounded-lg shadow p-6 mb-4 hover:shadow-lg transition">
                    <div className="flex gap-4">
                      <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0 ${
                        sub?.is_correct ? 'bg-green-500 text-white' : 'bg-indigo-600 text-white'
                      }`}>
                        {sub?.is_correct ? '‚úì' : i + 1}
                      </div>
                      <div className="flex-1">
                        <h3 className="text-lg font-bold mb-2 text-gray-800">{prob.title}</h3>
                        <p className="mb-4 text-gray-700">{txt}</p>
                        
                        <div className="flex gap-2 mb-4">
                          <input 
                            type="number" 
                            step="any" 
                            value={inp} 
                            onChange={(e) => setInputValues({ ...inputValues, [inputKey]: e.target.value })}
                            onKeyPress={(e) => {
                              if (e.key === 'Enter' && !isDisabled) {
                                submitAnswer(assignment.id, pid, inp);
                              }
                            }}
                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" 
                            placeholder={`Answer in ${prob.unit}`}
                            disabled={isDisabled}
                          />
                          <button 
                            onClick={() => submitAnswer(assignment.id, pid, inp)}
                            className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition font-medium"
                            disabled={isDisabled}
                          >
                            Submit
                          </button>
                        </div>

                        {sub && sub.user_answer && (
                          <div className={`p-4 rounded-lg border-2 ${
                            sub.is_correct ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'
                          }`}>
                            <div className="flex items-center gap-2 mb-2">
                              {sub.is_correct ? (
                                <>
                                  <span className="text-2xl"><CheckCircle /></span>
                                  <span className="font-bold text-green-800 text-lg">Correct!</span>
                                </>
                              ) : (
                                <>
                                  <span className="text-2xl"><XCircle /></span>
                                  <span className="font-bold text-red-800 text-lg">Incorrect</span>
                                </>
                              )}
                            </div>
                            <p className="text-sm text-gray-700">
                              Your answer: <span className="font-semibold">{parseFloat(sub.user_answer).toFixed(2)} {prob.unit}</span>
                            </p>
                            {!sub.is_correct && (
                              <>
                                <p className="text-sm text-red-700 mt-2 font-medium">
                                  Attempts used: {sub.attempts}/{prob.max_attempts}
                                </p>
                                {sub.attempts < prob.max_attempts ? (
                                  <p className="text-sm text-gray-600 mt-1">
                                    üí° Try again! Check your calculations.
                                  </p>
                                ) : (
                                  <div className="mt-3 p-3 bg-red-100 rounded border border-red-300">
                                    <p className="text-sm text-red-800 font-bold">
                                      Maximum attempts reached.
                                    </p>
                                    <p className="text-sm text-red-700 mt-1">
                                      Correct answer: <span className="font-bold">{parseFloat(sub.correct_answer).toFixed(2)} {prob.unit}</span>
                                    </p>
                                  </div>
                                )}
                              </>
                            )}
                          </div>
                        )}

                        {!sub && (
                          <p className="text-sm text-gray-500 italic">
                            Tolerance: ¬±{prob.tolerance_percent}% ‚Ä¢ Max attempts: {prob.max_attempts}
                          </p>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 p-6">
          <div className="max-w-4xl mx-auto">
            <div className="bg-white rounded-lg shadow p-6 mb-6">
              <div className="flex justify-between items-center">
                <h1 className="text-3xl font-bold text-gray-800">My Assignments</h1>
                <a href="/logout" className="flex items-center gap-2 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                  <LogOut /> Logout
                </a>
              </div>
            </div>

            {assignments.length === 0 ? (
              <div className="bg-white rounded-lg shadow p-12 text-center">
                <p className="text-gray-500 text-lg">No assignments yet</p>
                <p className="text-gray-400 text-sm mt-2">Check back later for new assignments from your teacher</p>
              </div>
            ) : (
              assignments.map(a => {
                const assignmentSubs = submissions.filter(s => s.assignment_id === a.id);
                const tot = a.problem_ids.length;
                const cor = assignmentSubs.filter(s => s.is_correct).length;
                const grd = tot > 0 ? (cor / tot * 100) : 0;
                const dueDate = new Date(a.due_date);
                const isOverdue = dueDate < new Date();

                return (
                  <div key={a.id} className="bg-white rounded-lg shadow p-6 mb-4 hover:shadow-lg transition border-l-4 border-indigo-600">
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex-1">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">
                          {a.title}
                          {cor > 0 && (
                            <span className={`ml-3 px-3 py-1 rounded-full text-sm font-bold ${
                              grd === 100 ? 'bg-green-100 text-green-800' : 
                              grd >= 70 ? 'bg-yellow-100 text-yellow-800' : 
                              'bg-red-100 text-red-800'
                            }`}>
                              {Math.round(grd)}%
                            </span>
                          )}
                        </h2>
                        <p className="text-gray-600 mb-3">{a.description}</p>
                        <div className="flex gap-4 text-sm text-gray-500">
                          <span className={isOverdue && cor < tot ? 'text-red-600 font-medium' : ''}>
                            üìÖ Due: {dueDate.toLocaleDateString()}
                            {isOverdue && cor < tot && ' (Overdue)'}
                          </span>
                          <span>üìù {tot} problem{tot !== 1 ? 's' : ''}</span>
                          {cor > 0 && <span>‚úì Score: {cor}/{tot}</span>}
                        </div>
                      </div>
                    </div>
                    <button 
                      onClick={() => setSelectedAssignment(a)}
                      className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium"
                    >
                      {cor === 0 ? '‚ñ∂ Start Assignment' : 
                       grd === 100 ? '‚úì Review' : 
                       '‚Üª Continue'}
                    </button>
                  </div>
                );
              })
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<StudentDashboard />, document.getElementById('root'));
  </script>
</body>
</html>
